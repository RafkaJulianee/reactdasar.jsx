<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Page Navigation Logic */
        .page { display: none; }
        .page.active { display: block; }

        /* Active Nav Link Styling */
        .nav-link.active svg,
        .nav-link.active span {
            color: #dc2626; /* red-600 */
        }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast {
            background-color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            animation: slideInRight 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
        }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* Skeleton Loader */
        .skeleton {
            background-color: #e2e8f0;
            border-radius: 0.5rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .6; }
        }
    </style>
</head>
<body class="pb-24">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[110] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-red-600"></div>
        <p class="mt-4 text-lg font-semibold text-slate-700">Menyambungkan...</p>
    </div>

    <!-- Header -->
    <header class="sticky top-0 bg-white/80 backdrop-blur-lg shadow-sm z-40">
        <div class="container mx-auto px-4 py-3">
            <h1 id="headerTitle" class="text-xl font-bold text-slate-800">Pesanan Masuk</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4">
        <!-- Page: Orders -->
        <div id="page-orders" class="page active fade-in">
            <div id="orders-container" class="space-y-4"></div>
        </div>

        <!-- Page: Menu Management -->
        <div id="page-menu" class="page fade-in">
             <div id="menu-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Page: Customers -->
        <div id="page-customers" class="page fade-in">
             <div id="customers-container" class="space-y-3"></div>
        </div>

        <!-- Page: Settings -->
        <div id="page-settings" class="page fade-in">
            <div class="space-y-6">
                <!-- Promo Banner Settings -->
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-4">Pengaturan Banner Promo</h3>
                    <form id="promo-form" class="space-y-3">
                        <input type="text" id="promoTitle" placeholder="Judul Promo" class="w-full rounded-lg border-slate-300 focus:border-red-500 focus:ring-red-500">
                        <input type="text" id="promoSubtitle" placeholder="Subjudul Promo" class="w-full rounded-lg border-slate-300 focus:border-red-500 focus:ring-red-500">
                        <button type="submit" class="w-full bg-red-600 text-white font-semibold py-2.5 rounded-lg hover:bg-red-700 transition">Simpan Promo</button>
                    </form>
                </div>
                 <!-- Category Settings -->
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Kategori Menu</h3>
                    </div>
                    <div id="categories-container" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Floating Action Button (FAB) -->
    <button id="fab" class="fixed bottom-24 right-5 bg-red-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-3xl font-light transform hover:scale-110 transition-transform z-40">
        +
    </button>

    <!-- Bottom Navbar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-50">
        <div class="flex justify-around items-center h-20 max-w-screen-md mx-auto">
            <button data-target="page-orders" class="nav-link active flex flex-col items-center justify-center w-full">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                <span class="text-xs font-medium text-slate-500 mt-1">Pesanan</span>
            </button>
            <button data-target="page-menu" class="nav-link flex flex-col items-center justify-center w-full">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
                <span class="text-xs font-medium text-slate-500 mt-1">Menu</span>
            </button>
            <button data-target="page-customers" class="nav-link flex flex-col items-center justify-center w-full">
                 <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                <span class="text-xs font-medium text-slate-500 mt-1">Pelanggan</span>
            </button>
            <button data-target="page-settings" class="nav-link flex flex-col items-center justify-center w-full">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="text-xs font-medium text-slate-500 mt-1">Pengaturan</span>
            </button>
        </div>
    </nav>

    <!-- Universal Form Modal -->
    <div id="form-modal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-end">
        <div class="bg-slate-50 w-full rounded-t-2xl slide-up">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h2 id="modal-title" class="font-bold text-lg">Modal Title</h2>
                    <button id="close-modal-btn" class="text-2xl text-slate-500 hover:text-slate-800">&times;</button>
                </div>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto">
                <form id="main-form" class="space-y-4"></form>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container space-y-2"></div>

<script type="module">
    // --- Firebase SDK ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, onSnapshot, writeBatch, query, where, addDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE & APP CONFIG ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'food-app-default';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

    let app, db, auth;
    
    // --- STATE MANAGEMENT ---
    let state = {
        menu: [], orders: [], categories: [], customers: [],
        settings: { promo: { title: '', subtitle: '' } },
        activePage: 'page-orders'
    };

    // --- DOM ELEMENTS ---
    const dom = {
        loadingOverlay: document.getElementById('loading-overlay'),
        pages: document.querySelectorAll('.page'),
        navLinks: document.querySelectorAll('.nav-link'),
        headerTitle: document.getElementById('headerTitle'),
        fab: document.getElementById('fab'),
        ordersContainer: document.getElementById('orders-container'),
        menuContainer: document.getElementById('menu-container'),
        customersContainer: document.getElementById('customers-container'),
        categoriesContainer: document.getElementById('categories-container'),
        formModal: document.getElementById('form-modal'),
        modalTitle: document.getElementById('modal-title'),
        mainForm: document.getElementById('main-form'),
        closeModalBtn: document.getElementById('close-modal-btn'),
        promoForm: {
            form: document.getElementById('promo-form'),
            title: document.getElementById('promoTitle'),
            subtitle: document.getElementById('promoSubtitle'),
        }
    };
    
    // --- INITIALIZATION ---
    async function initializeAdminPanel() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    attachAllListeners();
                    setupEventListeners();
                } else {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            dom.loadingOverlay.innerHTML = '<p class="text-red-500">Gagal terhubung ke server.</p>';
        }
    }
    
    function attachAllListeners() {
        renderSkeletons();
        let loaded = { orders: false, menu: false, customers: false, settings: false, categories: false };
        const checkAllLoaded = () => {
            if (Object.values(loaded).every(Boolean)) {
                dom.loadingOverlay.style.display = 'none';
            }
        };

        // Orders Listener & Customer Derivation
        const ordersRef = collection(db, `/artifacts/${appId}/public/data/orders`);
        onSnapshot(query(ordersRef, orderBy('timestamp', 'desc')), async (snapshot) => {
            state.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (state.activePage === 'page-orders') renderOrders();
            loaded.orders = true;

            // Derive customer list from orders to avoid permission errors
            const userIds = [...new Set(state.orders.map(order => order.userId).filter(Boolean))];
            if (userIds.length > 0) {
                const customerPromises = userIds.map(uid => getDoc(doc(db, `/artifacts/${appId}/users/${uid}/profile/info`)));
                const customerDocsSnaps = await Promise.all(customerPromises);
                state.customers = customerDocsSnaps
                    .map((docSnap, index) => {
                        if (docSnap.exists()) {
                            return { id: userIds[index], ...docSnap.data() };
                        }
                        return null;
                    })
                    .filter(Boolean);
            } else {
                state.customers = [];
            }
            if (state.activePage === 'page-customers') renderCustomers();
            loaded.customers = true;
            checkAllLoaded();
        });

        // Menu Listener
        const menuRef = collection(db, `/artifacts/${appId}/public/data/menu`);
        onSnapshot(menuRef, (snapshot) => {
            state.menu = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (state.activePage === 'page-menu') renderMenu();
            if (state.activePage === 'page-orders') renderOrders();
            loaded.menu = true; checkAllLoaded();
        });

        // Settings Listener
        const settingsRef = doc(db, `/artifacts/${appId}/public/data/settings/main`);
        onSnapshot(settingsRef, (doc) => {
            state.settings = doc.data() || { promo: { title: '', subtitle: '' } };
            if (state.activePage === 'page-settings') renderSettings();
            loaded.settings = true; checkAllLoaded();
        });

        // Categories Listener
        const categoriesRef = collection(db, `/artifacts/${appId}/public/data/categories`);
        onSnapshot(categoriesRef, (snapshot) => {
            state.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (state.activePage === 'page-settings') renderSettings();
            loaded.categories = true; checkAllLoaded();
        });
    }

    // --- RENDER FUNCTIONS ---
    function renderSkeletons() {
        const skeletonCard = (heightClass = 'h-32') => `<div class="skeleton ${heightClass} w-full"></div>`;
        dom.ordersContainer.innerHTML = Array(4).fill(skeletonCard()).join('<div class="my-4"></div>');
        dom.menuContainer.innerHTML = Array(3).fill(skeletonCard('h-24')).join('');
        dom.customersContainer.innerHTML = Array(5).fill(skeletonCard('h-16')).join('<div class="my-3"></div>');
    }

    function renderOrders() {
        dom.ordersContainer.innerHTML = state.orders.length === 0 
            ? `<p class="text-center text-slate-500 mt-8">Tidak ada pesanan masuk.</p>`
            : state.orders.map(order => {
                const details = order.details || {};
                const customerInfo = details.type === 'Online' 
                    ? `Online: ${details.name} - ${details.address}` 
                    : `Dine-in: ${details.name} - Meja ${details.table}`;
                
                const statusClasses = {
                    'Pending': 'bg-amber-100 text-amber-700',
                    'Preparing': 'bg-blue-100 text-blue-700',
                    'Ready': 'bg-green-100 text-green-700',
                    'Completed': 'bg-slate-100 text-slate-600'
                };

                return `
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">#${order.id.slice(-6).toUpperCase()}</p>
                            <p class="text-xs text-slate-500">${customerInfo}</p>
                        </div>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClasses[order.status] || 'bg-gray-100'}">${order.status}</span>
                    </div>
                    <ul class="text-sm list-disc list-inside my-2 pl-2 text-slate-700">
                        ${order.items.map(item => `<li>${item.quantity}x ${state.menu.find(m => m.id === item.menuItemId)?.name || '<i>Item Dihapus</i>'}</li>`).join('')}
                    </ul>
                    <div class="border-t pt-2 flex justify-between items-center">
                        <p class="font-bold text-red-600">Rp ${details.total?.toLocaleString('id-ID') || 'N/A'}</p>
                        <select data-id="${order.id}" class="order-status-selector text-sm rounded-lg border-slate-300 focus:ring-red-500 focus:border-red-500">
                            <option ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option ${order.status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                            <option ${order.status === 'Ready' ? 'selected' : ''}>Ready</option>
                            <option ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </div>
                </div>
            `}).join('');
    }

    function renderMenu() {
        dom.menuContainer.innerHTML = state.menu.map(item => `
            <div class="bg-white p-3 rounded-xl shadow-sm flex items-start space-x-3">
                <img src="${item.image}" class="w-20 h-20 object-contain rounded-lg bg-slate-100 p-1" onerror="this.onerror=null;this.src='https://placehold.co/80x80/f1f5f9/dc2626?text=Img';">
                <div class="flex-1">
                    <p class="font-bold">${item.name}</p>
                    <p class="text-sm text-red-600 font-semibold">Rp ${item.price.toLocaleString('id-ID')}</p>
                    <p class="text-xs text-slate-500">${item.category}</p>
                </div>
                <div class="flex flex-col space-y-2">
                    <button data-id="${item.id}" class="edit-menu-btn text-slate-400 hover:text-slate-700">‚úèÔ∏è</button>
                    <button data-id="${item.id}" class="delete-menu-btn text-slate-400 hover:text-red-600">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }
    
    function renderCustomers() {
        dom.customersContainer.innerHTML = state.customers.length === 0 
        ? `<p class="text-center text-slate-500 mt-8">Belum ada data pelanggan.</p>`
        : state.customers.map(c => `
             <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
                <div>
                    <p class="font-semibold">${c.name}</p>
                    <p class="text-xs text-slate-400">ID: ...${c.id.slice(-6)}</p>
                </div>
                <p class="font-bold text-amber-600">${c.points} Poin</p>
            </div>
        `).join('');
    }
    
    function renderSettings() {
        dom.promoForm.title.value = state.settings.promo?.title || '';
        dom.promoForm.subtitle.value = state.settings.promo?.subtitle || '';
        dom.categoriesContainer.innerHTML = state.categories.map(cat => `
            <div class="bg-slate-100 p-2 rounded-lg flex justify-between items-center">
                <p>${cat.icon} ${cat.name}</p>
                <button data-id="${cat.id}" class="delete-category-btn text-red-500 text-sm font-semibold">Hapus</button>
            </div>
        `).join('');
    }
    
    // --- PAGE NAVIGATION ---
    function switchPage(targetPageId) {
        state.activePage = targetPageId;
        const pageTitles = { 'page-orders': 'Pesanan Masuk', 'page-menu': 'Kelola Menu', 'page-customers': 'Data Pelanggan', 'page-settings': 'Pengaturan' };
        dom.headerTitle.textContent = pageTitles[targetPageId];
        dom.pages.forEach(p => p.classList.toggle('active', p.id === targetPageId));
        dom.navLinks.forEach(l => l.classList.toggle('active', l.dataset.target === targetPageId));
        dom.fab.style.display = ['page-menu', 'page-settings'].includes(targetPageId) ? 'flex' : 'none';
        
        // Ensure content is rendered on switch
        if (targetPageId === 'page-orders') renderOrders();
        else if (targetPageId === 'page-menu') renderMenu();
        else if (targetPageId === 'page-customers') renderCustomers();
        else if (targetPageId === 'page-settings') renderSettings();
    }

    // --- MODAL & FORM HANDLING ---
    function openFormModal(mode, data = {}) {
        let formHTML = '';
        switch(mode) {
            case 'add-menu': case 'edit-menu':
                dom.modalTitle.textContent = mode === 'add-menu' ? 'Tambah Menu' : 'Edit Menu';
                formHTML = `
                    <input type="hidden" name="id" value="${data.id || ''}">
                    <input type="text" name="name" placeholder="Nama Makanan" class="w-full rounded-lg border-slate-300" value="${data.name || ''}" required>
                    <input type="number" name="price" placeholder="Harga" class="w-full rounded-lg border-slate-300" value="${data.price || ''}" required>
                    <input type="text" name="image" placeholder="URL Gambar" class="w-full rounded-lg border-slate-300" value="${data.image || ''}" required>
                    <input type="text" name="rating" placeholder="Rating (e.g., 4.5)" class="w-full rounded-lg border-slate-300" value="${data.rating || ''}" required>
                    <select name="category" class="w-full rounded-lg border-slate-300" required>
                        ${state.categories.map(c => `<option value="${c.name}" ${data.category === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}
                    </select>
                    <textarea name="description" placeholder="Deskripsi" class="w-full rounded-lg border-slate-300">${data.description || ''}</textarea>
                    <button type="submit" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg">Simpan Menu</button>
                `;
                break;
            case 'add-category':
                 dom.modalTitle.textContent = 'Tambah Kategori';
                 formHTML = `<input type="text" name="name" placeholder="Nama Kategori" class="w-full rounded-lg" required><input type="text" name="icon" placeholder="Ikon Emoji (misal: üçπ)" class="w-full rounded-lg" required><button type="submit" class="w-full bg-red-600 text-white py-3 rounded-lg">Simpan</button>`;
                 break;
        }
        dom.mainForm.innerHTML = formHTML;
        dom.mainForm.dataset.mode = mode;
        dom.formModal.classList.remove('hidden');
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        const mode = e.target.dataset.mode;

        try {
            switch(mode) {
                case 'add-menu':
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/menu`), {
                        ...data, price: Number(data.price), rating: data.rating
                    });
                    showToast('Menu berhasil ditambahkan', 'success');
                    break;
                case 'edit-menu': 
                    const menuRef = doc(db, `/artifacts/${appId}/public/data/menu`, data.id);
                    await updateDoc(menuRef, { ...data, price: Number(data.price), rating: data.rating });
                    showToast('Menu berhasil diperbarui', 'success');
                    break;
                case 'add-category':
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/categories`), data);
                    showToast('Kategori berhasil ditambahkan', 'success');
                    break;
            }
        } catch (error) {
            console.error("Form submission error:", error);
            showToast('Terjadi kesalahan', 'error');
        }
        
        dom.formModal.classList.add('hidden');
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span class="font-semibold text-sm text-slate-700">${message}</span>`;
        document.getElementById('toast-container').appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        dom.navLinks.forEach(link => link.addEventListener('click', () => switchPage(link.dataset.target)));
        dom.fab.addEventListener('click', () => {
            if (state.activePage === 'page-menu') openFormModal('add-menu');
            if (state.activePage === 'page-settings') openFormModal('add-category');
        });
        
        dom.closeModalBtn.addEventListener('click', () => dom.formModal.classList.add('hidden'));
        dom.mainForm.addEventListener('submit', handleFormSubmit);

        // Delegated event listeners for dynamic content
        document.body.addEventListener('change', async e => {
            if (e.target.matches('.order-status-selector')) {
                const orderId = e.target.dataset.id;
                const newStatus = e.target.value;
                const orderRef = doc(db, `/artifacts/${appId}/public/data/orders`, orderId);
                try {
                    await updateDoc(orderRef, { status: newStatus });
                    showToast(`Status pesanan #${orderId.slice(-6).toUpperCase()} diperbarui`, 'success');
                } catch (error) {
                    showToast('Gagal memperbarui status', 'error');
                    console.error(error);
                }
            }
        });

        document.body.addEventListener('click', async e => {
            if (e.target.matches('.edit-menu-btn')) {
                const menuItem = state.menu.find(m => m.id === e.target.dataset.id);
                if(menuItem) openFormModal('edit-menu', menuItem);
            }
            if (e.target.matches('.delete-menu-btn')) {
                const menuId = e.target.dataset.id;
                if (window.confirm('Yakin ingin hapus menu ini? Aksi ini tidak dapat dibatalkan.')) {
                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/menu`, menuId));
                    showToast('Menu berhasil dihapus.', 'success');
                }
            }
            if (e.target.matches('.delete-category-btn')) {
                const catId = e.target.dataset.id;
                 if (window.confirm('Yakin ingin hapus kategori ini?')) {
                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/categories`, catId));
                    showToast('Kategori berhasil dihapus.', 'success');
                }
            }
        });

        dom.promoForm.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const promoData = {
                title: dom.promoForm.title.value,
                subtitle: dom.promoForm.subtitle.value
            };
            const settingsRef = doc(db, `/artifacts/${appId}/public/data/settings/main`);
            await setDoc(settingsRef, { promo: promoData }, { merge: true });
            showToast('Info promo berhasil disimpan!', 'success');
        });
    }

    initializeAdminPanel();
</script>
</body>
</html>

