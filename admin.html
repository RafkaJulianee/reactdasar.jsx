<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .page { display: none; }
        .page.active { display: block; }
        .nav-link.active svg,
        .nav-link.active span {
            color: #dc2626; /* red-600 */
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast {
            background-color: white; padding: 12px 20px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center;
            animation: slideInRight 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
        }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body class="pb-24">

    <!-- Header -->
    <header class="sticky top-0 bg-white/80 backdrop-blur-lg shadow-sm z-40">
        <div class="container mx-auto px-4 py-3">
            <h1 id="headerTitle" class="text-xl font-bold text-slate-800">Pesanan Masuk</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4">
        <!-- Page: Orders -->
        <div id="page-orders" class="page active fade-in">
            <div id="orders-container" class="space-y-4"></div>
        </div>
        <!-- Page: Menu Management -->
        <div id="page-menu" class="page fade-in">
             <div id="menu-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
        <!-- Page: Customers -->
        <div id="page-customers" class="page fade-in">
             <div id="customers-container" class="space-y-3"></div>
        </div>
        <!-- Page: Settings -->
        <div id="page-settings" class="page fade-in">
            <div class="space-y-6">
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-4">Pengaturan Banner Promo</h3>
                    <form id="promo-form" class="space-y-3">
                        <input type="text" id="promoTitle" placeholder="Judul Promo" class="w-full rounded-lg border-slate-300 focus:border-red-500 focus:ring-red-500">
                        <input type="text" id="promoSubtitle" placeholder="Subjudul Promo" class="w-full rounded-lg border-slate-300 focus:border-red-500 focus:ring-red-500">
                        <button type="submit" class="w-full bg-red-600 text-white font-semibold py-2.5 rounded-lg hover:bg-red-700 transition">Simpan Promo</button>
                    </form>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Kategori Menu</h3>
                    </div>
                    <div id="categories-container" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Floating Action Button (FAB) -->
    <button id="fab" class="fixed bottom-24 right-5 bg-red-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-3xl font-light transform hover:scale-110 transition-transform z-40">
        +
    </button>

    <!-- Bottom Navbar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-50">
        <div class="flex justify-around items-center h-20 max-w-screen-md mx-auto">
            <button data-target="page-orders" class="nav-link active flex flex-col items-center justify-center w-full">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                <span class="text-xs font-medium text-slate-500 mt-1">Pesanan</span>
            </button>
            <button data-target="page-menu" class="nav-link flex flex-col items-center justify-center w-full">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
                <span class="text-xs font-medium text-slate-500 mt-1">Menu</span>
            </button>
            <button data-target="page-customers" class="nav-link flex flex-col items-center justify-center w-full">
                 <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                <span class="text-xs font-medium text-slate-500 mt-1">Pelanggan</span>
            </button>
            <button data-target="page-settings" class="nav-link flex flex-col items-center justify-center w-full">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="text-xs font-medium text-slate-500 mt-1">Pengaturan</span>
            </button>
        </div>
    </nav>

    <!-- Universal Form Modal -->
    <div id="form-modal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-end">
        <div class="bg-slate-50 w-full rounded-t-2xl slide-up">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h2 id="modal-title" class="font-bold text-lg">Modal Title</h2>
                    <button id="close-modal-btn" class="text-2xl text-slate-500 hover:text-slate-800">&times;</button>
                </div>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto">
                <form id="main-form" class="space-y-4"></form>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container space-y-2"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let state = {
        menu: [], orders: [], categories: [], customers: [],
        settings: { promo: { title: '', subtitle: '' } },
        activePage: 'page-orders'
    };

    // --- DOM ELEMENTS ---
    const dom = {
        pages: document.querySelectorAll('.page'),
        navLinks: document.querySelectorAll('.nav-link'),
        headerTitle: document.getElementById('headerTitle'),
        fab: document.getElementById('fab'),
        ordersContainer: document.getElementById('orders-container'),
        menuContainer: document.getElementById('menu-container'),
        customersContainer: document.getElementById('customers-container'),
        categoriesContainer: document.getElementById('categories-container'),
        formModal: document.getElementById('form-modal'),
        modalTitle: document.getElementById('modal-title'),
        mainForm: document.getElementById('main-form'),
        closeModalBtn: document.getElementById('close-modal-btn'),
    };
    
    // --- DATA HANDLING (localStorage) ---
    function loadState() {
        state.menu = JSON.parse(localStorage.getItem('menuItems')) || [];
        state.orders = JSON.parse(localStorage.getItem('orders')) || [];
        state.categories = JSON.parse(localStorage.getItem('categories')) || [];
        state.settings = JSON.parse(localStorage.getItem('storeSettings')) || { promo: { title: '', subtitle: '' }};
        deriveCustomersFromOrders();
    }

    function saveState() {
        localStorage.setItem('menuItems', JSON.stringify(state.menu));
        localStorage.setItem('orders', JSON.stringify(state.orders));
        localStorage.setItem('categories', JSON.stringify(state.categories));
        localStorage.setItem('storeSettings', JSON.stringify(state.settings));
    }
    
    // --- INITIALIZATION ---
    function initializeApp() {
        loadState();
        renderAll();
        setupEventListeners();
        // Periodically check for new orders from the customer app
        setInterval(() => {
            const newOrdersRaw = localStorage.getItem('orders');
            if (newOrdersRaw && JSON.stringify(state.orders) !== newOrdersRaw) {
                console.log("Pesanan baru terdeteksi!");
                loadState();
                if(state.activePage === 'page-orders') renderOrders();
                if(state.activePage === 'page-customers') renderCustomers();
            }
        }, 2000); // Check every 2 seconds
    }

    // --- RENDER FUNCTIONS ---
    function renderAll() {
        if(state.activePage === 'page-orders') renderOrders();
        if(state.activePage === 'page-menu') renderMenu();
        if(state.activePage === 'page-customers') renderCustomers();
        if(state.activePage === 'page-settings') renderSettings();
    }

    function renderOrders() {
        const sortedOrders = [...state.orders].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        dom.ordersContainer.innerHTML = sortedOrders.length === 0 
            ? `<p class="text-center text-slate-500 mt-8">Tidak ada pesanan masuk.</p>`
            : sortedOrders.map(order => {
                const details = order.details || {};
                 const customerInfo = details.type === 'Online' 
                    ? `Online: ${details.name} - ${details.address}` 
                    : `Dine-in: ${details.name} - Meja ${details.table}`;
                const statusClasses = {
                    'Pending': 'bg-amber-100 text-amber-700', 'Preparing': 'bg-blue-100 text-blue-700',
                    'Ready': 'bg-green-100 text-green-700', 'Completed': 'bg-slate-100 text-slate-600'
                };
                return `
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">#${order.id.slice(-6).toUpperCase()}</p>
                            <p class="text-xs text-slate-500">${customerInfo}</p>
                        </div>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClasses[order.status] || 'bg-gray-100'}">${order.status}</span>
                    </div>
                    <ul class="text-sm list-disc list-inside my-2 pl-2">
                        ${order.items.map(item => `<li>${item.quantity}x ${state.menu.find(m => m.id === item.id)?.name || '<i>Item Dihapus</i>'}</li>`).join('')}
                    </ul>
                    <div class="border-t pt-2 flex justify-between items-center">
                        <p class="font-bold text-red-600">Rp ${details.total?.toLocaleString('id-ID') || 'N/A'}</p>
                        <select data-id="${order.id}" class="order-status-selector text-sm rounded-lg border-slate-300 focus:ring-red-500 focus:border-red-500">
                            <option ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option ${order.status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                            <option ${order.status === 'Ready' ? 'selected' : ''}>Ready</option>
                            <option ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </div>
                </div>
            `}).join('');
    }

    function renderMenu() {
        dom.menuContainer.innerHTML = state.menu.map(item => `
            <div class="bg-white p-3 rounded-xl shadow-sm flex items-start space-x-3">
                <img src="${item.image}" class="w-20 h-20 object-contain rounded-lg bg-slate-100 p-1" onerror="this.onerror=null;this.src='https://placehold.co/80x80/f1f5f9/dc2626?text=Img';">
                <div class="flex-1">
                    <p class="font-bold">${item.name}</p>
                    <p class="text-sm text-red-600 font-semibold">Rp ${item.price.toLocaleString('id-ID')}</p>
                    <p class="text-xs text-slate-500">${item.category}</p>
                </div>
                <div class="flex flex-col space-y-2">
                    <button data-id="${item.id}" class="edit-menu-btn text-slate-400 hover:text-slate-700">✏️</button>
                    <button data-id="${item.id}" class="delete-menu-btn text-slate-400 hover:text-red-600">🗑️</button>
                </div>
            </div>
        `).join('');
    }
    
    function renderCustomers() {
        dom.customersContainer.innerHTML = state.customers.length === 0 
        ? `<p class="text-center text-slate-500 mt-8">Belum ada data pelanggan.</p>`
        : state.customers.map(c => `
             <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
                <div>
                    <p class="font-semibold">${c.name}</p>
                    <p class="text-xs text-slate-400">ID: ...${c.id.slice(-6)}</p>
                </div>
                <p class="font-bold text-amber-600">${c.points} Poin</p>
            </div>
        `).join('');
    }
    
    function renderSettings() {
        document.getElementById('promoTitle').value = state.settings.promo.title;
        document.getElementById('promoSubtitle').value = state.settings.promo.subtitle;
        dom.categoriesContainer.innerHTML = state.categories.map(cat => `
            <div class="bg-slate-100 p-2 rounded-lg flex justify-between items-center">
                <p>${cat.icon} ${cat.name}</p>
                <button data-id="${cat.id}" class="delete-category-btn text-red-500 text-sm font-semibold">Hapus</button>
            </div>
        `).join('');
    }
    
    function deriveCustomersFromOrders() {
        const customersMap = new Map();
        // Get customer data directly from orders to avoid async issues
        state.orders.forEach(order => {
             const userId = order.userId;
             const userInOrder = order.details.name;
             // Try to find more complete user data from localStorage if available
             const fullUser = JSON.parse(localStorage.getItem('currentUser'));
             if (userId && !customersMap.has(userId)) {
                 customersMap.set(userId, {
                     id: userId,
                     name: userInOrder || 'Unknown',
                     points: fullUser && fullUser.id === userId ? fullUser.points : 'N/A'
                 });
             }
        });
        state.customers = Array.from(customersMap.values());
    }

    // --- PAGE NAVIGATION ---
    function switchPage(targetPageId) {
        state.activePage = targetPageId;
        const pageTitles = { 'page-orders': 'Pesanan Masuk', 'page-menu': 'Kelola Menu', 'page-customers': 'Data Pelanggan', 'page-settings': 'Pengaturan' };
        dom.headerTitle.textContent = pageTitles[targetPageId];
        dom.pages.forEach(p => p.classList.toggle('active', p.id === targetPageId));
        dom.navLinks.forEach(l => l.classList.toggle('active', l.dataset.target === targetPageId));
        dom.fab.style.display = ['page-menu', 'page-settings'].includes(targetPageId) ? 'flex' : 'none';
        renderAll();
    }

    // --- MODAL & FORM HANDLING ---
    function openFormModal(mode, data = {}) {
        let formHTML = '';
        switch(mode) {
            case 'add-menu': case 'edit-menu':
                dom.modalTitle.textContent = mode === 'add-menu' ? 'Tambah Menu' : 'Edit Menu';
                formHTML = `
                    <input type="hidden" name="id" value="${data.id || ''}">
                    <input type="text" name="name" placeholder="Nama Makanan" class="w-full rounded-lg border-slate-300" value="${data.name || ''}" required>
                    <input type="number" name="price" placeholder="Harga" class="w-full rounded-lg border-slate-300" value="${data.price || ''}" required>
                    <input type="text" name="image" placeholder="URL Gambar" class="w-full rounded-lg border-slate-300" value="${data.image || ''}" required>
                    <input type="text" name="rating" placeholder="Rating (e.g., 4.5)" class="w-full rounded-lg border-slate-300" value="${data.rating || ''}" required>
                    <select name="category" class="w-full rounded-lg border-slate-300" required>
                        ${state.categories.map(c => `<option value="${c.name}" ${data.category === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}
                    </select>
                    <textarea name="description" placeholder="Deskripsi" class="w-full rounded-lg border-slate-300">${data.description || ''}</textarea>
                    <button type="submit" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg">Simpan Menu</button>
                `;
                break;
            case 'add-category':
                 dom.modalTitle.textContent = 'Tambah Kategori';
                 formHTML = `<input type="text" name="name" placeholder="Nama Kategori" class="w-full rounded-lg" required><input type="text" name="icon" placeholder="Ikon Emoji (misal: 🍹)" class="w-full rounded-lg" required><button type="submit" class="w-full bg-red-600 text-white py-3 rounded-lg">Simpan</button>`;
                 break;
        }
        dom.mainForm.innerHTML = formHTML;
        dom.mainForm.dataset.mode = mode;
        dom.formModal.classList.remove('hidden');
    }

    function handleFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        const mode = e.target.dataset.mode;

        switch(mode) {
            case 'add-menu': 
                state.menu.push({ ...data, id: `menu_${Date.now()}`, price: Number(data.price) }); 
                break;
            case 'edit-menu': 
                const idx = state.menu.findIndex(i => i.id == data.id);
                if (idx > -1) state.menu[idx] = { ...state.menu[idx], ...data, price: Number(data.price) };
                break;
            case 'add-category': 
                state.categories.push({ ...data, id: `cat_${Date.now()}` }); 
                break;
        }
        
        saveState();
        renderAll();
        dom.formModal.classList.add('hidden');
        showToast('Data berhasil disimpan!', 'success');
    }

    function addNotification(message, userId) {
        const notifs = JSON.parse(localStorage.getItem('notifications')) || [];
        notifs.push({ id: `notif_${Date.now()}`, message, userId });
        localStorage.setItem('notifications', JSON.stringify(notifs));
    }
    
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span class="font-semibold text-sm text-slate-700">${message}</span>`;
        document.getElementById('toast-container').appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        dom.navLinks.forEach(link => link.addEventListener('click', () => switchPage(link.dataset.target)));
        dom.fab.addEventListener('click', () => {
            if (state.activePage === 'page-menu') openFormModal('add-menu');
            if (state.activePage === 'page-settings') openFormModal('add-category');
        });
        
        dom.closeModalBtn.addEventListener('click', () => dom.formModal.classList.add('hidden'));
        dom.mainForm.addEventListener('submit', handleFormSubmit);

        document.body.addEventListener('change', e => {
            if (e.target.matches('.order-status-selector')) {
                const orderId = e.target.dataset.id;
                const newStatus = e.target.value;
                const orderIndex = state.orders.findIndex(o => o.id === orderId);
                if (orderIndex > -1) {
                    state.orders[orderIndex].status = newStatus;
                    saveState();
                    renderOrders();
                    showToast(`Status pesanan #${orderId.slice(-6).toUpperCase()} diperbarui`, 'success');
                    addNotification(`Pesanan #${orderId.slice(-6).toUpperCase()} sekarang ${newStatus}!`, state.orders[orderIndex].userId);
                }
            }
        });

        document.body.addEventListener('click', e => {
            if (e.target.matches('.edit-menu-btn')) {
                openFormModal('edit-menu', state.menu.find(m => m.id === e.target.dataset.id));
            }
            if (e.target.matches('.delete-menu-btn')) {
                if (confirm('Yakin ingin hapus menu ini?')) {
                    state.menu = state.menu.filter(m => m.id !== e.target.dataset.id);
                    saveState(); renderMenu();
                }
            }
            if (e.target.matches('.delete-category-btn')) {
                 if (confirm('Yakin ingin hapus kategori ini?')) {
                    state.categories = state.categories.filter(c => c.id !== e.target.dataset.id);
                    saveState(); renderSettings();
                }
            }
        });

        document.getElementById('promo-form').addEventListener('submit', e => {
            e.preventDefault();
            state.settings.promo.title = document.getElementById('promoTitle').value;
            state.settings.promo.subtitle = document.getElementById('promoSubtitle').value;
            saveState();
            showToast('Info promo berhasil disimpan!');
        });
    }

    initializeApp();
});
</script>
</body>
</html>

