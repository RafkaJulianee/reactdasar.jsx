<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesan Makanan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif;
            background-color: #f7f7f7;
        }
        .fade-in { animation: fadeIn 0.5s ease-out both; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(30px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .payment-option.selected {
            border-color: #dc2626; /* red-600 */
            background-color: #fee2e2; /* red-100 */
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Main Content -->
    <main class="container mx-auto px-5 pt-6 pb-32">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Menu</h1>
                <p class="text-slate-500 text-sm">Cari makanan favoritmu</p>
            </div>
            <div class="text-right">
                <p id="userName" class="font-semibold text-slate-700">Guest</p>
                <div class="flex items-center justify-end space-x-1 font-bold text-amber-600">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                    <span id="userPoints">0</span> 
                    <span>Poin</span>
                </div>
            </div>
        </header>

        <!-- Search Bar, Categories, Promo, Menu -->
        <div class="relative mb-6">
            <input id="search-input" type="text" placeholder="Cari apa saja..." class="w-full pl-12 pr-4 py-3 bg-white rounded-full shadow-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-red-400">
            <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </div>
        <div class="mb-6">
            <div id="category-filter" class="flex space-x-4 overflow-x-auto no-scrollbar pb-2"></div>
        </div>
        <div id="promo-banner" class="bg-red-700 rounded-2xl p-5 flex items-center justify-between text-white mb-8 shadow-lg shadow-red-500/20">
            <div>
                <h3 id="promoTitle" class="font-bold text-lg">Dapatkan Gratis!</h3>
                <p id="promoSubtitle" class="text-sm opacity-90">Minuman dingin di setiap pesanan burger.</p>
            </div>
            <img src="https://assets.stickpng.com/images/580b57fcd9996e24bc43c1a8.png" class="w-24 transform -rotate-12">
        </div>
        <h2 class="text-xl font-bold text-slate-900 mb-4">Menu Hari Ini</h2>
        <div id="menu-container" class="grid grid-cols-2 gap-x-4 gap-y-6"></div>
    </main>

    <!-- Bottom Navbar -->
    <nav class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[90%] max-w-sm z-50">
        <div class="bg-white rounded-full shadow-xl flex justify-around items-center p-2.5">
            <a href="#" class="text-red-600"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg></a>
            <a href="#" class="text-slate-400"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></a>
            <button id="cartButton" class="relative text-slate-400">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                <span id="cartCount" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] rounded-full h-4 w-4 flex items-center justify-center font-bold">0</span>
            </button>
            <a href="#" class="text-slate-400"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></a>
        </div>
    </nav>
    
    <!-- All Modals Container -->
    <div id="modal-container">
        <!-- Product Detail Modal -->
        <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-[70] flex items-center justify-center p-4 modal-backdrop">
             <div class="bg-white rounded-3xl shadow-xl w-full max-w-sm mx-auto slide-up relative">
                <div class="h-56 -mt-16 flex justify-center items-center">
                     <img id="detailImage" src="" alt="Product Image" class="max-h-full max-w-full drop-shadow-2xl">
                </div>
                <button class="close-modal-btn absolute top-4 left-4 bg-white/70 backdrop-blur-sm rounded-full p-2 text-slate-800">&lt;</button>
                <div class="p-6">
                     <div class="flex justify-between items-start">
                        <h3 id="detailName" class="text-2xl font-bold text-slate-900">Nama Produk</h3>
                        <div class="flex items-center space-x-1 bg-amber-100 text-amber-700 px-2 py-1 rounded-full text-sm font-bold"><span>‚≠ê</span><span>4.5</span></div>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <div id="detailPoints" class="text-red-600 font-semibold">+0 Poin</div>
                        <div id="detailPrice" class="text-2xl font-extrabold text-slate-900">Rp 0</div>
                    </div>
                    <p id="detailDesc" class="text-slate-500 mt-4 text-sm leading-relaxed">Deskripsi produk.</p>
                    <button id="detailAddToCart" class="mt-6 w-full bg-red-600 text-white font-bold py-4 rounded-full">Tambah ke Keranjang</button>
                </div>
            </div>
        </div>
        <!-- Cart Modal -->
        <div id="cartModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-end modal-backdrop">
            <div class="bg-white rounded-t-3xl shadow-xl w-full slide-up">
                 <div class="p-5 border-b flex justify-between items-center"><h3 class="text-xl font-semibold">Keranjang</h3><button class="close-modal-btn text-3xl">&times;</button></div>
                <div id="cartItems" class="p-5 max-h-[40vh] overflow-y-auto no-scrollbar"></div>
                <div class="p-5 bg-slate-50 rounded-b-3xl space-y-3">
                    <div class="flex justify-between items-center"><span class="text-lg">Total:</span><span id="cartTotal" class="text-2xl font-bold text-red-600">Rp 0</span></div>
                    <button id="checkoutButton" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl disabled:opacity-50">Lanjut Bayar</button>
                </div>
            </div>
        </div>
        <!-- Checkout Type Modal -->
        <div id="checkoutTypeModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[80] flex items-center justify-center p-4 modal-backdrop">
             <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs mx-auto slide-up p-6 text-center space-y-4">
                <h3 class="font-bold text-lg">Pilih Tipe Pesanan</h3>
                <button data-type="Dine-in" class="checkout-type-btn w-full bg-red-100 text-red-700 py-3 rounded-lg">Makan di Tempat</button>
                <button data-type="Online" class="checkout-type-btn w-full bg-red-100 text-red-700 py-3 rounded-lg">Pesan Online</button>
                <button class="close-modal-btn mt-2 text-slate-500 text-sm">Batal</button>
            </div>
        </div>
        <!-- Dine-in Form Modal -->
        <div id="dineInModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[80] flex items-end modal-backdrop">
            <div class="bg-white rounded-t-3xl shadow-xl w-full slide-up">
                <div class="p-5 border-b flex justify-between items-center"><h3 class="text-xl font-semibold">Pilih Meja</h3><button class="close-modal-btn text-3xl">&times;</button></div>
                <form id="dineInForm" class="p-5 space-y-4">
                    <input type="text" name="name" placeholder="Nama Anda" class="w-full rounded-lg border-slate-300" required>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">Pilih Nomor Meja:</label>
                        <div id="table-selection" class="grid grid-cols-4 gap-3"></div>
                        <input type="hidden" name="table" required>
                    </div>
                    <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl mt-2">Lanjut ke Pembayaran</button>
                </form>
            </div>
        </div>
        <!-- Online Order - Location Check Modal -->
        <div id="onlineOrderModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[80] flex items-end modal-backdrop">
            <div class="bg-white rounded-t-3xl shadow-xl w-full slide-up">
                 <div class="p-5 border-b flex justify-between items-center"><h3 class="text-xl font-semibold">Detail Pengiriman</h3><button class="close-modal-btn text-3xl">&times;</button></div>
                 <div id="location-check-container" class="p-5 space-y-3">
                    <!-- Location checking UI will be injected here -->
                 </div>
            </div>
        </div>
        <!-- THE NEW PAYMENT MODAL -->
        <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[90] flex items-end modal-backdrop">
            <div class="bg-slate-50 rounded-t-3xl shadow-xl w-full slide-up max-h-[90vh] flex flex-col">
                <div class="p-5 border-b bg-white rounded-t-3xl">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">Pembayaran</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl">&times;</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-5">
                    <div class="bg-white rounded-xl p-4 mb-4">
                        <h4 class="font-bold mb-2">Ringkasan Pesanan</h4>
                        <div id="payment-summary-items" class="space-y-2 text-sm"></div>
                        <div class="border-t mt-3 pt-3 space-y-1">
                            <div class="flex justify-between text-sm"><span class="text-slate-600">Subtotal</span><span id="payment-subtotal"></span></div>
                            <div class="flex justify-between text-sm"><span class="text-slate-600">Biaya Pengiriman</span><span id="payment-delivery-fee"></span></div>
                            <div class="flex justify-between font-bold"><span class="text-slate-800">Total</span><span id="payment-total" class="text-red-600"></span></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-4">
                        <h4 class="font-bold mb-3">Metode Pembayaran</h4>
                        <div class="space-y-3">
                            <button class="payment-option w-full flex items-center p-3 border-2 border-slate-200 rounded-lg text-left">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Logo_ovo_purple.svg/1280px-Logo_ovo_purple.svg.png" class="h-6 mr-4">
                                <span class="font-semibold">OVO</span>
                            </button>
                            <button class="payment-option w-full flex items-center p-3 border-2 border-slate-200 rounded-lg text-left">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/72/Logo_dana_blue.svg/1280px-Logo_dana_blue.svg.png" class="h-5 mr-4">
                                <span class="font-semibold">DANA</span>
                            </button>
                            <button class="payment-option w-full flex items-center p-3 border-2 border-slate-200 rounded-lg text-left">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/86/Gopay_logo.svg/2560px-Gopay_logo.svg.png" class="h-4 mr-4">
                                <span class="font-semibold">GoPay</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-5 bg-white border-t">
                    <button id="final-pay-button" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed">Bayar Sekarang</button>
                </div>
            </div>
        </div>
        <!-- Order Success Modal -->
        <div id="orderSuccessModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4 modal-backdrop">
             <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs mx-auto slide-up p-6 text-center space-y-3">
                <div class="w-16 h-16 bg-emerald-100 rounded-full mx-auto flex items-center justify-center">
                    <svg class="w-10 h-10 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                </div>
                <h3 class="font-bold text-xl">Pesanan Diterima!</h3>
                <p id="success-message" class="text-slate-500 text-sm"></p>
                <button class="close-modal-btn w-full bg-red-600 text-white font-semibold py-2.5 rounded-lg mt-2">Tutup</button>
            </div>
        </div>
    </div>
    <div id="toast-container" class="toast-container space-y-2"></div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE & CONFIG ---
    const RESTAURANT_LOCATION = { lat: -6.1753924, lng: 106.8271528 }; // Monas, Jakarta
    const MAX_DELIVERY_DISTANCE_KM = 4;
    const MIN_ONLINE_ORDER_RP = 50000;
    const DELIVERY_FEE_RP = 8000;

    let state = {
        menu: [], categories: [], settings: {}, cart: [], currentUser: null,
        orderData: {} 
    };
    
    // --- DOM ELEMENTS (Cached) ---
    const dom = {
        menuContainer: document.getElementById('menu-container'),
        categoryFilter: document.getElementById('category-filter'),
        searchInput: document.getElementById('search-input'),
        userName: document.getElementById('userName'),
        userPoints: document.getElementById('userPoints'),
        promoTitle: document.getElementById('promoTitle'),
        promoSubtitle: document.getElementById('promoSubtitle'),
        cartButton: document.getElementById('cartButton'),
        cartCount: document.getElementById('cartCount'),
        modalContainer: document.getElementById('modal-container'),
        cartItems: document.getElementById('cartItems'),
        cartTotal: document.getElementById('cartTotal'),
        checkoutButton: document.getElementById('checkoutButton')
    };

    // --- INITIALIZATION ---
    function initializeApp() {
        state.menu = JSON.parse(localStorage.getItem('menuItems')) || [];
        state.categories = JSON.parse(localStorage.getItem('categories')) || [];
        state.settings = JSON.parse(localStorage.getItem('storeSettings')) || {};
        state.cart = JSON.parse(localStorage.getItem('cart')) || [];
        state.currentUser = JSON.parse(localStorage.getItem('currentUser')) || { id: `user_${Date.now()}`, name: 'Budi', points: 150 };
        localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
        
        renderAll();
        setupEventListeners();
        setInterval(checkNotifications, 4000);
    }
    
    // --- RENDER FUNCTIONS ---
    function renderAll() {
        renderUserInfo();
        renderPromoBanner();
        renderCategories();
        renderMenu();
        updateCartUI();
    }
    
    function renderUserInfo() { dom.userName.textContent = state.currentUser.name; dom.userPoints.textContent = state.currentUser.points.toLocaleString('id-ID'); }
    function renderPromoBanner() { if (state.settings.promo) { dom.promoTitle.textContent = state.settings.promo.title; dom.promoSubtitle.textContent = state.settings.promo.subtitle; } }
    function renderCategories() {
        const allCategories = [{ name: 'All', icon: 'üî•' }, ...state.categories];
        dom.categoryFilter.innerHTML = allCategories.map((cat, i) => `<button data-category="${cat.name}" class="category-btn flex flex-col items-center space-y-2 flex-shrink-0 w-20"><div class="w-16 h-16 rounded-2xl flex items-center justify-center ${i === 0 ? 'bg-red-600 text-white' : 'bg-white'} text-2xl shadow-sm">${cat.icon}</div><span class="text-sm font-medium ${i === 0 ? 'text-red-600' : 'text-slate-600'}">${cat.name}</span></button>`).join('');
    }
    function renderMenu(category = 'All', searchTerm = '') {
        let filteredMenu = state.menu.filter(item => (category === 'All' || item.category === category) && item.name.toLowerCase().includes(searchTerm.toLowerCase()));
        dom.menuContainer.innerHTML = filteredMenu.map(item => `<div data-id="${item.id}" class="menu-item-card bg-white p-3 rounded-2xl shadow-md fade-in cursor-pointer"><div class="h-28 flex items-center justify-center mb-2"><img src="${item.image}" alt="${item.name}" class="max-h-full max-w-full drop-shadow-lg"></div><h3 class="font-semibold text-sm truncate">${item.name}</h3><div class="flex justify-between items-center mt-2"><p class="font-bold">Rp${(item.price/1000).toFixed(0)}k</p><button data-id="${item.id}" class="add-to-cart-btn bg-red-600 text-white w-8 h-8 rounded-full font-bold text-lg">+</button></div></div>`).join('');
    }

    // --- CART LOGIC ---
    function getCartTotal() {
        return state.cart.reduce((sum, item) => sum + (state.menu.find(m => m.id === item.id)?.price || 0) * item.quantity, 0);
    }
    function updateCartUI() {
        dom.cartCount.textContent = state.cart.reduce((sum, item) => sum + item.quantity, 0);
        localStorage.setItem('cart', JSON.stringify(state.cart));
        renderCartItems();
    }
    function renderCartItems() {
        if (document.getElementById('cartModal').classList.contains('hidden')) return;
        const total = getCartTotal();
        if (state.cart.length === 0) {
            dom.cartItems.innerHTML = '<p class="text-slate-500 text-center py-8">Keranjangmu kosong.</p>';
            dom.cartTotal.textContent = 'Rp 0'; dom.checkoutButton.disabled = true; return;
        }
        dom.cartItems.innerHTML = state.cart.map(cartItem => {
            const menuItem = state.menu.find(m => m.id === cartItem.id);
            return `<div class="flex justify-between items-center py-3 border-b"><div class="flex items-center space-x-3"><img src="${menuItem.image}" class="w-12 h-12 object-contain bg-slate-100 rounded-lg p-1"><div><p class="font-semibold">${menuItem.name}</p><p class="text-sm text-slate-500">Rp ${menuItem.price.toLocaleString('id-ID')}</p></div></div><div class="flex items-center space-x-3"><button data-id="${menuItem.id}" class="decrease-qty-btn bg-slate-200 w-7 h-7 rounded-full font-bold">-</button><span>${cartItem.quantity}</span><button data-id="${menuItem.id}" class="increase-qty-btn bg-red-600 text-white w-7 h-7 rounded-full font-bold">+</button></div></div>`;
        }).join('');
        dom.cartTotal.textContent = `Rp ${total.toLocaleString('id-ID')}`;
        dom.checkoutButton.disabled = false;
    }
    function addToCart(itemId) {
        const existingItem = state.cart.find(item => item.id === itemId);
        if (existingItem) existingItem.quantity++;
        else state.cart.push({ id: itemId, quantity: 1 });
        updateCartUI();
        showToast('Berhasil ditambahkan!', 'success');
    }
    function changeQuantity(itemId, change) {
        const idx = state.cart.findIndex(item => item.id === itemId);
        if (idx > -1) { state.cart[idx].quantity += change; if (state.cart[idx].quantity <= 0) state.cart.splice(idx, 1); }
        updateCartUI();
    }

    // --- CHECKOUT & PAYMENT FLOW ---
    function openModal(modalId) { closeAllModals(); document.getElementById(modalId).classList.remove('hidden'); }
    function closeAllModals() { dom.modalContainer.querySelectorAll('.fixed').forEach(modal => modal.classList.add('hidden')); }

    function startCheckout() { openModal('checkoutTypeModal'); }

    function handleCheckoutTypeSelect(type) {
        const total = getCartTotal();
        if (type === 'Online' && total < MIN_ONLINE_ORDER_RP) {
            showToast(`Minimal pesanan online adalah Rp ${MIN_ONLINE_ORDER_RP.toLocaleString('id-ID')}`, 'error'); return;
        }
        state.orderData = { type };
        if (type === 'Dine-in') {
            let tablesHTML = ''; for (let i = 1; i <= 20; i++) tablesHTML += `<button type="button" data-table="${i}" class="table-select-btn h-14 rounded-lg bg-slate-100 font-bold">${i}</button>`;
            document.getElementById('table-selection').innerHTML = tablesHTML;
            openModal('dineInModal');
        } else {
            handleOnlineOrder();
        }
    }

    function handleOnlineOrder() {
        const container = document.getElementById('location-check-container');
        container.innerHTML = `<div class="text-center p-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto"></div><p class="mt-4 font-semibold">Mengecek lokasi Anda...</p></div>`;
        openModal('onlineOrderModal');

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                const distance = getDistance(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng, latitude, longitude);
                
                if (distance <= MAX_DELIVERY_DISTANCE_KM) {
                    container.innerHTML = `<form id="onlineOrderForm" class="space-y-4"><p class="text-sm text-green-600 bg-green-100 p-3 rounded-lg">‚úÖ Lokasi Anda dalam jangkauan kami! (Jarak: ${distance.toFixed(2)} km)</p><input type="text" name="address" placeholder="Alamat Lengkap Anda" class="w-full rounded-lg border-slate-300" required><textarea name="notes" placeholder="Catatan untuk kurir (opsional)" class="w-full rounded-lg border-slate-300"></textarea><button type="submit" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl mt-2">Lanjut ke Pembayaran</button></form>`;
                } else {
                    container.innerHTML = `<div class="text-center p-8"><p class="text-lg font-bold text-red-700">Diluar Jangkauan!</p><p class="text-slate-600 mt-2">Maaf, lokasi Anda berjarak ${distance.toFixed(2)} km, melebihi batas pengiriman kami (${MAX_DELIVERY_DISTANCE_KM} km).</p><button class="close-modal-btn mt-4 bg-slate-200 px-4 py-2 rounded-lg">Tutup</button></div>`;
                }
            },
            () => {
                container.innerHTML = `<div class="text-center p-8"><p class="text-lg font-bold text-red-700">Lokasi Gagal!</p><p class="text-slate-600 mt-2">Tidak dapat mengakses lokasi Anda. Mohon izinkan akses lokasi di browser Anda untuk melanjutkan.</p><button class="close-modal-btn mt-4 bg-slate-200 px-4 py-2 rounded-lg">Tutup</button></div>`;
            }
        );
    }
    
    function renderPaymentModal() {
        const subtotal = getCartTotal();
        const deliveryFee = state.orderData.type === 'Online' ? DELIVERY_FEE_RP : 0;
        const total = subtotal + deliveryFee;

        document.getElementById('payment-summary-items').innerHTML = state.cart.map(item => {
            const menuItem = state.menu.find(m => m.id === item.id);
            return `<div class="flex justify-between"><span class="text-slate-600">${item.quantity}x ${menuItem.name}</span><span>Rp ${(menuItem.price * item.quantity).toLocaleString('id-ID')}</span></div>`;
        }).join('');
        
        document.getElementById('payment-subtotal').textContent = `Rp ${subtotal.toLocaleString('id-ID')}`;
        document.getElementById('payment-delivery-fee').textContent = `Rp ${deliveryFee.toLocaleString('id-ID')}`;
        document.getElementById('payment-total').textContent = `Rp ${total.toLocaleString('id-ID')}`;
        document.getElementById('final-pay-button').disabled = true;
        document.querySelectorAll('.payment-option').forEach(btn => btn.classList.remove('selected'));
        
        openModal('paymentModal');
    }

    function processFinalOrder() {
        const total = getCartTotal() + (state.orderData.type === 'Online' ? DELIVERY_FEE_RP : 0);
        const pointsEarned = Math.floor(total / 1000);
        const newOrder = { id: `order_${Date.now()}`, timestamp: new Date().toISOString(), status: 'Pending', items: state.cart, total, customerInfo: state.orderData };

        const allOrders = JSON.parse(localStorage.getItem('orders')) || [];
        allOrders.push(newOrder);
        localStorage.setItem('orders', JSON.stringify(allOrders));

        state.currentUser.points += pointsEarned;
        localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
        
        state.cart = []; updateCartUI(); renderUserInfo();
        
        const successMsg = state.orderData.type === 'Online' 
            ? `Pesananmu akan tiba dalam <strong>20-30 menit</strong>. Terima kasih!`
            : `Pesananmu untuk <strong>Meja ${state.orderData.table}</strong> akan segera disiapkan. Terima kasih!`;
        document.getElementById('success-message').innerHTML = successMsg;
        openModal('orderSuccessModal');
    }

    // --- HELPERS & NOTIFICATIONS ---
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the earth in km
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }
    function showToast(message, type = 'info') { /* ... implementation ... */ }
    function checkNotifications() { /* ... implementation ... */ }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        dom.menuContainer.addEventListener('click', e => {
            if (e.target.closest('.add-to-cart-btn')) { e.stopPropagation(); addToCart(parseInt(e.target.closest('.add-to-cart-btn').dataset.id)); return; }
            if (e.target.closest('.menu-item-card')) { /* open detail modal */ }
        });
        dom.categoryFilter.addEventListener('click', e => { /* category filtering */ });
        dom.searchInput.addEventListener('input', () => { /* search logic */ });
        dom.cartButton.addEventListener('click', () => { openModal('cartModal'); renderCartItems(); });
        dom.checkoutButton.addEventListener('click', startCheckout);

        document.body.addEventListener('click', e => {
            if (e.target.matches('.close-modal-btn')) closeAllModals();
            if (e.target.matches('.checkout-type-btn')) handleCheckoutTypeSelect(e.target.dataset.type);
            if (e.target.matches('.increase-qty-btn')) changeQuantity(parseInt(e.target.dataset.id), 1);
            if (e.target.matches('.decrease-qty-btn')) changeQuantity(parseInt(e.target.dataset.id), -1);
            if (e.target.matches('.table-select-btn')) {
                document.querySelectorAll('.table-select-btn').forEach(btn => btn.classList.remove('bg-red-600', 'text-white'));
                e.target.classList.add('bg-red-600', 'text-white');
                document.querySelector('#dineInForm input[name="table"]').value = e.target.dataset.table;
            }
             if (e.target.closest('.payment-option')) {
                document.querySelectorAll('.payment-option').forEach(btn => btn.classList.remove('selected'));
                e.target.closest('.payment-option').classList.add('selected');
                document.getElementById('final-pay-button').disabled = false;
            }
            if(e.target.matches('#final-pay-button')) processFinalOrder();
        });
        
        document.getElementById('dineInForm').addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            state.orderData = { ...state.orderData, ...Object.fromEntries(formData.entries()) };
            renderPaymentModal();
        });
         document.body.addEventListener('submit', e => {
            if(e.target.id === 'onlineOrderForm') {
                e.preventDefault();
                const formData = new FormData(e.target);
                state.orderData = { ...state.orderData, ...Object.fromEntries(formData.entries()) };
                renderPaymentModal();
            }
        });
    }

    initializeApp();
});
</script>
</body>
</html>

